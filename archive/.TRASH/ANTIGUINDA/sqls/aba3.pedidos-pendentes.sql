/*SELECT DISTINCT CAB.NUNOTA
, CAB.DTNEG
, CAB.DTPREVENT
, PAR.NOMEPARC
, VEN.APELIDO
, USU.NOMEUSU
FROM TGFCAB CAB
JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA
JOIN TGFPAR PAR ON PAR.CODPARC = CAB.CODPARC
LEFT JOIN TGFVEN VEN ON VEN.CODVEND      = CAB.CODVEND
LEFT JOIN TSIUSU USU ON USU.CODUSU       = CAB.CODUSUINC
WHERE ((QTDNEG - QTDENTREGUE > 0) AND ITE.PENDENTE = 'S')
    AND TIPMOV = 'O'
    AND CAB.STATUSNOTA = 'L'
    AND CAB.CODTIPOPER NOT IN (111,113,132,133,2800)*/

SELECT CASE WHEN CAB.NUMCOTACAO IS NOT NULL THEN COT.NUNOTAORIG ELSE CAB.AD_NUNOTAREQORIG END AS NURC, USUREQ.NOMEUSU AS REQUISITANTE, VEN.APELIDO, CAB.NUNOTA, CAB.NUMCOTACAO, PRO.DESCRPROD, ITE.CONTROLE
, CASE CAB.CODVEICULO 
    WHEN 0 THEN 'Uso e Consumo' 
    ELSE VEI.PLACA 
    END AS APLICACAO
, USU.NOMEUSU AS COMPRADOR, CONVERT(VARCHAR,CAB.DTNEG,103) DTNEG , CAB.DTPREVENT
, CONCAT(PAR.CODPARC, ' - ', PAR.NOMEPARC) AS FORNECEDOR
, PAR.CGC_CPF
, CASE CAB.AD_PRIORIDADE
    WHEN 0 THEN 'EMERGÃŠNCIA'
    WHEN 1 THEN 'MUITO URGENTE'
    WHEN 2 THEN 'URGENTE'
    WHEN 3 THEN 'POUCO URGENTE'
    WHEN 4 THEN 'PROGRAMADA'
        END PRIORIDADE
, CASE CAB.AD_PRIORIDADE
		WHEN 0 THEN '#FF9393'
		WHEN 1 THEN '#FFCCCC'
		WHEN 2 THEN '#EDE73D'
		WHEN 3 THEN '#35C7F5'
		WHEN 4 THEN '#B8B8B8'
		 END AS BKCOLOR
, CASE WHEN CAB.AD_PRIORIDADE IS NOT NULL THEN CONCAT(CASE CAB.AD_PRIORIDADE
    WHEN 0 THEN 0
    WHEN 1 THEN 1
    WHEN 2 THEN 2
    WHEN 3 THEN 5
    WHEN 4 THEN '+7'
        END,' Dia(s)') ELSE NULL END PRAZO
, DATEDIFF(day, GETDATE(), CAB.DTPREVENT) AS 'CONTROLE_DIAS'
FROM TGFCAB CAB
  JOIN TGFITE ITE ON ITE.NUNOTA = CAB.NUNOTA
  JOIN TGFPRO PRO ON PRO.CODPROD = ITE.CODPROD
  JOIN TGFPAR PAR ON PAR.CODPARC = CAB.CODPARC
  LEFT JOIN TGFVEN VEN ON VEN.CODVEND = CAB.CODVEND
  JOIN TGFVEI VEI ON VEI.CODVEICULO = CAB.CODVEICULO
  JOIN TSIUSU USU ON USU.CODUSU = CAB.CODUSUINC

  LEFT JOIN TGFCOT COT ON COT.NUMCOTACAO = CAB.NUMCOTACAO
  LEFT JOIN TGFCAB REQ ON REQ.NUNOTA = (CASE WHEN CAB.NUMCOTACAO IS NOT NULL THEN COT.NUNOTAORIG ELSE CAB.AD_NUNOTAREQORIG END)
  LEFT JOIN TSIUSU USUREQ ON USUREQ.CODUSU = REQ.CODUSUINC

WHERE ((QTDNEG - QTDENTREGUE > 0) AND ITE.PENDENTE = 'S')
  AND CAB.CODUSUINC NOT IN (172,22)
  AND CAB.TIPMOV = 'O'
  AND CAB.STATUSNOTA = 'L'
  AND CAB.CODTIPOPER  NOT IN (3,111,113,132,133,2800)
  AND ITE.CODPROD NOT IN (2519,5044,99999)
ORDER BY 1 DESC



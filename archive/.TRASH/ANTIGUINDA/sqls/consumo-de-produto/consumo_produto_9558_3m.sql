-- Consumo do produto 9558 nos últimos 3 meses (2025-10-01 a 2025-12-31)
DECLARE @codprod INT = 9558;
DECLARE @dt_start DATE = '2025-10-01';
DECLARE @dt_end DATE   = '2025-12-31';

-- 1) Por comprador (ROLLUP para total geral)
SELECT
  CASE WHEN GROUPING(USU.NOMEUSU) = 1 THEN 'TOTAL GERAL' ELSE USU.NOMEUSU END AS comprador,
  COUNT(DISTINCT CAB.NUNOTA) AS qtdConfirmados,
  SUM(CASE WHEN fin.comprasPagas IS NOT NULL THEN 1 ELSE 0 END) AS qtdExecutados,
  SUM(CAB.VLRNOTA) AS vlrConfirmados
FROM [SANKHYA].[TGFCAB] CAB
  JOIN [SANKHYA].[TGFITE] ITE ON ITE.NUNOTA = CAB.NUNOTA AND ITE.CODEMP = CAB.CODEMP
  LEFT JOIN (
  SELECT NUNOTA, 1 AS comprasPagas
  FROM [SANKHYA].[TGFFIN]
  WHERE DHBAIXA IS NOT NULL
  GROUP BY NUNOTA
) fin ON fin.NUNOTA = CAB.NUNOTA
  JOIN [SANKHYA].[TSIUSU] USU ON USU.CODUSU = CAB.CODUSUINC
WHERE CAB.TIPMOV = 'O'
  AND CAB.STATUSNOTA = 'L'
  AND CAB.DTNEG BETWEEN @dt_start AND @dt_end
  AND ITE.CODPROD = @codprod
  AND CAB.CODUSUINC IN (104,107,263,309)
GROUP BY ROLLUP(USU.NOMEUSU)
ORDER BY CASE WHEN GROUPING(USU.NOMEUSU) = 1 THEN 2 ELSE 1 END, USU.NOMEUSU;

-- 2) Total de pedidos confirmados para o produto no período
SELECT COUNT(DISTINCT CAB.NUNOTA) AS total_pedidos_confirmados
FROM [SANKHYA].[TGFCAB] CAB
  JOIN [SANKHYA].[TGFITE] ITE ON ITE.NUNOTA = CAB.NUNOTA AND ITE.CODEMP = CAB.CODEMP
WHERE CAB.TIPMOV = 'O'
  AND CAB.STATUSNOTA = 'L'
  AND CAB.DTNEG BETWEEN @dt_start AND @dt_end
  AND ITE.CODPROD = @codprod;
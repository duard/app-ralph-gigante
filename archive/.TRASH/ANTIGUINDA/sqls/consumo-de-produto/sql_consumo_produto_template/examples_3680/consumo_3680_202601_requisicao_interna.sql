-- Consumo do produto 3680 via Requisição Interna (CODTIPOPER = 400)
-- Período: Janeiro de 2026 (mês corrente)

DECLARE @codprod INT = 3680;
DECLARE @dt_start DATETIME = '2026-01-01';
DECLARE @dt_end DATETIME = '2026-01-31 23:59:59';

-- Resumo: soma de valor (linha VLRTOT), quantidade e número de notas
SELECT
  TGFTOP.CODTIPOPER AS CODTIPOPER,
  LTRIM(RTRIM(TGFTOP.DESCROPER)) AS OPERACAO,
  COUNT(DISTINCT C.NUNOTA) AS NOTAS_DISTINTAS,
  SUM(ISNULL(I.QTDNEG,0)) AS QTD_TOTAL_NEGADA,
  SUM(ISNULL(I.VLRTOT, I.QTDNEG * I.VLRUNIT)) AS TOTAL_GASTO
FROM [SANKHYA].[TGFITE] I
  JOIN [SANKHYA].[TGFCAB] C ON C.NUNOTA = I.NUNOTA AND C.CODEMP = I.CODEMP
  JOIN [SANKHYA].[TGFTOP] TGFTOP ON TGFTOP.CODTIPOPER = C.CODTIPOPER
WHERE I.CODPROD = @codprod
  AND TGFTOP.CODTIPOPER = 400 -- Requisição Interna
  AND C.DTNEG BETWEEN @dt_start AND @dt_end
  AND C.STATUSNOTA = 'L'
GROUP BY TGFTOP.CODTIPOPER, LTRIM(RTRIM(TGFTOP.DESCROPER));

-- (Opcional) Detalhe por nota
SELECT DISTINCT C.NUNOTA, C.DTNEG, C.TIPMOV, C.STATUSNOTA, I.SEQ, I.CODPROD, I.QTDNEG, I.VLRUNIT, I.VLRTOT
FROM [SANKHYA].[TGFITE] I
  JOIN [SANKHYA].[TGFCAB] C ON C.NUNOTA = I.NUNOTA AND C.CODEMP = I.CODEMP
  JOIN [SANKHYA].[TGFTOP] TGFTOP ON TGFTOP.CODTIPOPER = C.CODTIPOPER
WHERE I.CODPROD = @codprod
  AND TGFTOP.CODTIPOPER = 400
  AND C.DTNEG BETWEEN @dt_start AND @dt_end
  AND C.STATUSNOTA = 'L'
ORDER BY C.DTNEG DESC, C.NUNOTA, I.SEQ;
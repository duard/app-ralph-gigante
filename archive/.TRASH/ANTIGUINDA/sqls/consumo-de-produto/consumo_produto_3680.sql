-- Consumo do produto 3680
-- Objetivo: contar e listar saídas (movimentos que reduzem estoque)
-- Regra: consideramos TGFTOP.ATUALEST = 'B' (baixa/saída)

DECLARE @codprod INT = 3680;

-- 1) Linhas detalhadas (notas/itens) que causaram baixa para o produto
SELECT
  C.NUNOTA,
  C.CODEMP,
  C.DTMOV,
  C.TIPMOV,
  TGFTOP.CODTIPOPER,
  TGFTOP.DESCROPER,
  TGFTOP.ATUALEST,
  I.CODPROD,
  I.QTDNEG,
  I.VLRTOT,
  P.DESCRPROD
FROM [SANKHYA].[TGFITE] I
  JOIN [SANKHYA].[TGFCAB] C ON C.NUNOTA = I.NUNOTA AND C.CODEMP = I.CODEMP
  LEFT JOIN [SANKHYA].[TGFTOP] TGFTOP ON TGFTOP.CODTIPOPER = C.CODTIPOPER
  LEFT JOIN [SANKHYA].[TGFPRO] P ON P.CODPROD = I.CODPROD
WHERE I.CODPROD = @codprod
  AND TGFTOP.ATUALEST = 'B'
ORDER BY C.DTMOV DESC;

-- 2) Resumo: quantas linhas e quantas notas distintas
SELECT
  COUNT(1) AS LINHAS_DE_SAIDA,
  COUNT(DISTINCT C.NUNOTA) AS NOTAS_DISTINTAS,
  SUM(ISNULL(I.QTDNEG,0)) AS QTD_TOTAL_NEGATIVA
FROM [SANKHYA].[TGFITE] I
  JOIN [SANKHYA].[TGFCAB] C ON C.NUNOTA = I.NUNOTA AND C.CODEMP = I.CODEMP
  LEFT JOIN [SANKHYA].[TGFTOP] TGFTOP ON TGFTOP.CODTIPOPER = C.CODTIPOPER
WHERE I.CODPROD = @codprod
  AND TGFTOP.ATUALEST = 'B';

-- 3) Resumo por mês (ano-mês)
SELECT
  LEFT(CONVERT(VARCHAR(10), C.DTMOV, 120),7) AS ANO_MES,
  COUNT(1) AS LINHAS,
  COUNT(DISTINCT C.NUNOTA) AS NOTAS_DISTINTAS,
  SUM(ISNULL(I.QTDNEG,0)) AS QTD_TOTAL_NEGATIVA
FROM [SANKHYA].[TGFITE] I
  JOIN [SANKHYA].[TGFCAB] C ON C.NUNOTA = I.NUNOTA AND C.CODEMP = I.CODEMP
  LEFT JOIN [SANKHYA].[TGFTOP] TGFTOP ON TGFTOP.CODTIPOPER = C.CODTIPOPER
WHERE I.CODPROD = @codprod
  AND TGFTOP.ATUALEST = 'B'
GROUP BY LEFT(CONVERT(VARCHAR(10), C.DTMOV, 120),7)
ORDER BY ANO_MES DESC;

-- 4) Exemplo: filtrar especificamente Dezembro de 2025 (início pequeno, análise rápida)
-- Troque as datas se quiser outro período
DECLARE @dt_start_spec DATETIME = '2025-12-01';
DECLARE @dt_end_spec DATETIME = '2025-12-31 23:59:59';

-- a) Lista de notas com o produto no período (útil para inspeção rápida)
SELECT DISTINCT
  C.NUNOTA, C.CODEMP, C.DTNEG, C.TIPMOV, C.STATUSNOTA
FROM [SANKHYA].[TGFCAB] C
  JOIN [SANKHYA].[TGFITE] I ON I.NUNOTA = C.NUNOTA AND I.CODEMP = C.CODEMP
WHERE I.CODPROD = @codprod
  AND C.DTNEG BETWEEN @dt_start_spec AND @dt_end_spec
ORDER BY C.DTNEG DESC;

-- b) Contagem de notas de saída (exclui TIPMOV = 'O' que são compras) e soma de QTDNEG
SELECT
  COUNT(DISTINCT C.NUNOTA) AS NOTAS_SAIDA,
  SUM(ISNULL(I.QTDNEG,0)) AS QTD_TOTAL_SAIDA
FROM [SANKHYA].[TGFITE] I
  JOIN [SANKHYA].[TGFCAB] C ON C.NUNOTA = I.NUNOTA AND C.CODEMP = I.CODEMP
WHERE I.CODPROD = @codprod
  AND C.DTNEG BETWEEN @dt_start_spec AND @dt_end_spec
  AND C.TIPMOV <> 'O'
  AND C.STATUSNOTA = 'L';


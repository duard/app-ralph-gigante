-- Query para saldos anteriores e valores m√©dios do produto 3680 com saldo progressivo
WITH MOVIMENTACOES AS (
    SELECT
        CAB.NUNOTA,
        CAB.NUMNOTA,
        CAB.ORDEMCARGA,
        ITE.CODLOCALORIG,
        LO.DESCRLOCAL,
        ITE.CONTROLE,
        COALESCE(CAB.DTENTSAI, CAB.DTNEG) AS DATA_MOV,
        CAB.DTNEG,
        CAB.TIPMOV,
        CAB.CODPARC,
        PAR.NOMEPARC,
        (ITE.QTDNEG * ITE.ATUALESTOQUE) AS QTDNEG,
        (ITE.VLRTOT
         - ITE.VLRDESC
         - COALESCE(ITE.VLRREPRED,0)
         + ITE.VLRIPI
         + ITE.VLRSUBST)
         * VCA.INDITENS
         * CASE
               WHEN ITE.USOPROD = 'M' THEN OPR.GOLMPSINAL
               ELSE OPR.GOLSINAL
           END
         * OPR.GOLDEV
         * CASE
               WHEN ITE.SEQUENCIA < 0 THEN -1
               ELSE 1
           END
         * -1 AS VLRTOT,
        ITE.CODEMP,
        EMP.NOMEFANTASIA,
        OPR.CODTIPOPER,
        OPR.DESCROPER,
        OPR.GRUPO,
        CASE
            WHEN CAB.TIPMOV = 'T'
            THEN ITE.ATUALESTOQUE * -1
            ELSE ITE.ATUALESTOQUE
        END AS TRANSF_ORDEM,
        ITE.ATUALESTOQUE AS IMPACTO_FISICO
    FROM TGFCAB CAB
    JOIN TGFITE ITE ON ITE.NUNOTA = CAB.NUNOTA
    JOIN VGFCAB VCA ON VCA.NUNOTA = CAB.NUNOTA
    JOIN TGFPAR PAR ON PAR.CODPARC = CAB.CODPARC
    JOIN TGFTOP OPR ON OPR.CODTIPOPER = CAB.CODTIPOPER AND OPR.DHALTER = CAB.DHTIPOPER
    JOIN TSIEMP EMP ON EMP.CODEMP = ITE.CODEMP
    JOIN TGFLOC LO ON LO.CODLOCAL = ITE.CODLOCALORIG
    LEFT JOIN TGFVEN VEN ON VEN.CODVEND = CAB.CODVEND
    WHERE ITE.CODPROD = 3680
    AND ITE.ATUALESTOQUE <> 0
    AND ITE.RESERVA = 'N'
    AND COALESCE(CAB.DTENTSAI, CAB.DTNEG) >= '2025-12-01 00:00:00'
),
SALDO_INICIAL AS (
    SELECT 85 AS SALDO_INICIAL_QTD, 2014.50 AS SALDO_INICIAL_VLR
)

SELECT
    m.NUNOTA,
    m.NUMNOTA,
    m.ORDEMCARGA,
    m.CODLOCALORIG,
    m.DESCRLOCAL,
    m.CONTROLE,
    m.DATA_MOV,
    m.DTNEG,
    m.TIPMOV,
    m.CODPARC,
    m.NOMEPARC,
    m.QTDNEG,
    m.VLRTOT,
    m.CODEMP,
    m.NOMEFANTASIA,
    m.CODTIPOPER,
    m.DESCROPER,
    m.GRUPO,
    m.TRANSF_ORDEM,
    si.SALDO_INICIAL_QTD +
      SUM(m.IMPACTO_FISICO) OVER (
        ORDER BY m.DATA_MOV, m.TRANSF_ORDEM DESC, m.NUNOTA
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      ) AS SALDO_QTD_APOS,
    si.SALDO_INICIAL_VLR +
      SUM(m.VLRTOT) OVER (
        ORDER BY m.DATA_MOV, m.TRANSF_ORDEM DESC, m.NUNOTA
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      ) AS SALDO_VLR_APOS,
    CASE WHEN SUM(m.QTDNEG) OVER (
        ORDER BY m.DATA_MOV, m.TRANSF_ORDEM DESC, m.NUNOTA
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      ) <> 0
      THEN (si.SALDO_INICIAL_VLR + SUM(m.VLRTOT) OVER (
        ORDER BY m.DATA_MOV, m.TRANSF_ORDEM DESC, m.NUNOTA
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      )) / (si.SALDO_INICIAL_QTD + SUM(m.IMPACTO_FISICO) OVER (
        ORDER BY m.DATA_MOV, m.TRANSF_ORDEM DESC, m.NUNOTA
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
      ))
      ELSE 0
    END AS VALOR_MEDIO_APOS
FROM MOVIMENTACOES m
CROSS JOIN SALDO_INICIAL si
ORDER BY m.DATA_MOV, m.TRANSF_ORDEM DESC, m.NUNOTA;
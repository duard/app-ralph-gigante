-- Query: Quem solicitou e teve aprovação para retirada do estoque - Produto 3680 Dezembro 2025
WITH BASE AS (
    SELECT 
        ITE.NUNOTA,
        FORMAT(PRO.CODPROD, '000000') + ' - ' + RTRIM(PRO.DESCRPROD) + 
        CASE 
            WHEN NULLIF(RTRIM(ITE.CONTROLE), '') IS NOT NULL 
            THEN ' ' + RTRIM(ITE.CONTROLE) 
            ELSE '' 
        END AS PRODUTO,
        ITE.QTDNEG AS QUANTIDADE,
        CAB.DTNEG AS DATA_NEGOCIACAO,
        FORMAT(CAB.CODUSUINC, '0000') + ' - ' + RTRIM(USU.NOMEUSU) + ' - ' + RTRIM(GRU.NOMEGRUPO) AS USUARIO,
        (
            SELECT TOP 1 NUMCOTACAO 
            FROM TGFCOT COT WITH (NOLOCK)
            WHERE COT.NUNOTAORIG = CAB.NUNOTA
        ) AS NUM_COTACAO,
        FORMAT(TP.CODTIPOPER, '0000') + ' - ' + RTRIM(TP.DESCROPER) AS DESC_TOP,
        ROW_NUMBER() OVER (
            PARTITION BY ITE.NUNOTA, PRO.CODPROD 
            ORDER BY ITE.DTALTER DESC
        ) AS RN
    FROM TGFITE ITE WITH (NOLOCK)
    INNER JOIN TGFCAB CAB WITH (NOLOCK) 
        ON CAB.NUNOTA = ITE.NUNOTA 
       AND CAB.NUNOTA > 0
    INNER JOIN TGFPRO PRO WITH (NOLOCK) 
        ON PRO.CODPROD = ITE.CODPROD
    INNER JOIN TSIUSU USU WITH (NOLOCK) 
        ON USU.CODUSU = CAB.CODUSUINC
    INNER JOIN TSIGRU GRU WITH (NOLOCK) 
        ON GRU.CODGRUPO = USU.CODGRUPO
    LEFT JOIN TGFTOP TP WITH (NOLOCK) 
        ON TP.CODTIPOPER = CAB.CODTIPOPER
    WHERE PRO.CODPROD = 3680
        AND EXISTS (
            SELECT 1 
            FROM TSILIB WITH (NOLOCK)
            WHERE NUCHAVE = CAB.NUNOTA
              AND DHLIB IS NOT NULL
              AND VLRLIBERADO >= 0
              AND REPROVADO <> 'S'
        )
        AND CAB.DTNEG BETWEEN '2025-12-01' AND '2025-12-31'
)
SELECT 
    NUNOTA,
    PRODUTO,
    QUANTIDADE,
    DATA_NEGOCIACAO,
    USUARIO,
    NUM_COTACAO,
    DESC_TOP
FROM BASE
WHERE RN = 1
ORDER BY DATA_NEGOCIACAO DESC;
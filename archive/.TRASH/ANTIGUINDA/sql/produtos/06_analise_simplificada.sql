-- Query simples para an√°lise do comprador 3680
SELECT 
    LEFT(CONVERT(VARCHAR(10), c.DTMOV, 120), 7) AS ano_mes,
    MONTH(c.DTMOV) AS mes,
    SUM(CASE WHEN c.TIPMOV = 'C' THEN i.QTDNEG ELSE 0 END) AS quantidade_comprada,
    SUM(CASE WHEN c.TIPMOV = 'C' THEN i.VLRTOT ELSE 0 END) AS valor_comprado,
    SUM(CASE WHEN c.TIPMOV = 'O' AND t.DESCROPER NOT LIKE '%COMPRA%' AND t.DESCROPER NOT LIKE '%REQUISICAO%' THEN i.QTDNEG ELSE 0 END) AS quantidade_consumida,
    SUM(CASE WHEN c.TIPMOV = 'O' AND t.DESCROPER NOT LIKE '%COMPRA%' AND t.DESCROPER NOT LIKE '%REQUISICAO%' THEN i.VLRTOT ELSE 0 END) AS valor_consumido,
    SUM(CASE WHEN c.TIPMOV = 'O' AND (t.DESCROPER LIKE '%COMPRA%' OR t.DESCROPER LIKE '%REQUISICAO%') THEN i.QTDNEG ELSE 0 END) AS quantidade_interna,
    SUM(CASE WHEN c.TIPMOV = 'O' AND (t.DESCROPER LIKE '%COMPRA%' OR t.DESCROPER LIKE '%REQUISICAO%') THEN i.VLRTOT ELSE 0 END) AS valor_interno
    (SUM(CASE WHEN c.TIPMOV = 'C' THEN i.QTDNEG ELSE 0 END) - SUM(CASE WHEN c.TIPMOV = 'O' AND t.DESCROPER NOT LIKE '%COMPRA%' AND t.DESCROPER NOT LIKE '%REQUISICAO%' THEN i.QTDNEG ELSE 0 END)) AS saldo_disponivel
FROM TGFCAB c
JOIN TGFITE i ON i.NUNOTA = c.NUNOTA
LEFT JOIN TGFTOP t ON t.CODTIPOPER = c.CODTIPOPER
WHERE i.CODPROD = 3680
  AND c.STATUSNOTA = 'L'
  AND YEAR(c.DTMOV) = 2025
GROUP BY LEFT(CONVERT(VARCHAR(10), c.DTMOV, 120), 7), MONTH(c.DTMOV)
ORDER BY mes;
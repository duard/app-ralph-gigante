-- Query para saldos anteriores e valores m√©dios do produto 3680
SELECT
    CAB.NUNOTA,
    CAB.NUMNOTA,
    CAB.ORDEMCARGA,
    ITE.CODLOCALORIG,
    LO.DESCRLOCAL,
    ITE.CONTROLE,
    CAB.DTENTSAI,
    CAB.DTNEG,
    CAB.TIPMOV,
    CAB.CODPARC,
    PAR.NOMEPARC,
    (ITE.QTDNEG * ITE.ATUALESTOQUE) AS QTDNEG,
    (ITE.VLRTOT
     - ITE.VLRDESC
     - COALESCE(ITE.VLRREPRED,0)
     + ITE.VLRIPI
     + ITE.VLRSUBST)
     * VCA.INDITENS
     * CASE
           WHEN ITE.USOPROD = 'M' THEN OPR.GOLMPSINAL
           ELSE OPR.GOLSINAL
       END
     * OPR.GOLDEV
     * CASE
           WHEN ITE.SEQUENCIA < 0 THEN -1
           ELSE 1
       END
     * -1 AS VLRTOT,
    ITE.CODEMP,
    EMP.NOMEFANTASIA,
    OPR.CODTIPOPER,
    OPR.DESCROPER,
    OPR.GRUPO,
    CASE
        WHEN CAB.TIPMOV = 'T'
        THEN ITE.ATUALESTOQUE * -1
        ELSE ITE.ATUALESTOQUE
    END AS TRANSF_ORDEM
FROM TGFCAB CAB
JOIN TGFITE ITE ON ITE.NUNOTA = CAB.NUNOTA
JOIN VGFCAB VCA ON VCA.NUNOTA = CAB.NUNOTA
JOIN TGFPAR PAR ON PAR.CODPARC = CAB.CODPARC
JOIN TGFTOP OPR ON OPR.CODTIPOPER = CAB.CODTIPOPER AND OPR.DHALTER = CAB.DHTIPOPER
JOIN TSIEMP EMP ON EMP.CODEMP = ITE.CODEMP
JOIN TGFLOC LO ON LO.CODLOCAL = ITE.CODLOCALORIG
LEFT JOIN TGFVEN VEN ON VEN.CODVEND = CAB.CODVEND
WHERE ITE.CODPROD = 3680
AND ITE.ATUALESTOQUE <> 0
AND ITE.RESERVA = 'N'
AND COALESCE(CAB.DTENTSAI, CAB.DTNEG) >= '2025-12-01 00:00:00'
ORDER BY COALESCE(CAB.DTENTSAI, CAB.DTNEG), TRANSF_ORDEM DESC, CAB.NUNOTA;